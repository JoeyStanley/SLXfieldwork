
library(shiny)
library(tidyverse)
library(janitor)
library(stopwords)
library(joeyr)



process_data <- function(df) {
  df %>%
    clean_names() %>%
    select(speaker_id = name, everything(),
           -matches("lobanov"), -b1, -b2, -b3,-t, -beg, -end, -matches("word_trans"), -matches("_word"), -n_formants) %>%
    rename_with(ucfirst, matches("f\\d")) %>%
    rename(phoneme = vowel) %>%
    
    # Reshape 
    select(-F1, -F2, -F3) %>%
    pivot_longer(cols = matches("_percent"), 
                 names_to = c(".value", "percent"), 
                 names_pattern = "(F\\d)_(\\d\\d)") %>%
    mutate(percent = as.numeric(percent)) %>%
    filter(!is.na(F1), !is.na(F2)) %>%
    
    # OoO1 Allophones
    mutate(phoneme = arpa_to_wells(phoneme)) %>%
    code_allophones(phoneme, .fol_seg = fol_seg, .pre_seg = pre_seg) %>%
    
    # OoO2 Outliers
    group_by(speaker_id, phoneme) %>%
    filter(!find_outliers(F1, F2)) %>%
    ungroup() %>%
    
    # OoO3 Normalization
    group_by(speaker_id, phoneme) %>%
    mutate(across(.cols = c(F1, F2), 
                  .fns = c(`z` = scale, `log` = log10),
                  .names = "{.col}_{.fn}")) %>%
    # ungroup() %>%
    # norm_logmeans(c(F1_log, F2_log),
    #               .speaker_col = speaker_id,
    #               .vowel_col = phoneme) %>%
    
    # OoO4 Remove other data?
    print() %>%
    return()
}
  
vowels <- c("FLEECE", "KIT", "FACE", "DRESS", "TRAP", "LOT", "THOUGHT", "STRUT", "GOAT", "FOOT", "GOOSE", "PRICE", "MOUTH", "CHOICE", "NURSE")
stopwords <- stopwords(source = "marimo")
allwords <- c("")

# Define UI for application that draws a histogram
ui <- fluidPage(
  
  # Application title
  titlePanel("LING 580R Sociolinguistic Fieldwork: Acoustic Analysis"),
  
  sidebarLayout(
    sidebarPanel(width = 2,
      fileInput("uploaded_data", "Choose a DARLA-generated csv file",
                multiple = FALSE,
                accept = c("text/csv",
                           "text/comma-separated-values,text/plain",
                           ".csv")),
      actionButton(width = "100%", "process_uploaded_button", "Process my data"),
      #actionButton(width = "49%", "load_sample_button", "Use sample data instead"),
      hr(),
      p("This should be a .csv file that is generated by DARLA.")
    ),
    mainPanel(width = 10,
      
      tabsetPanel(
        type = "pills",
        tabPanel(
          title = "Main vowel plot",
          
          
          
          tabsetPanel(
            type = "tabs",
            
            tabPanel(
              title = "Vowels",
              fluidRow(
                column(3,
                       selectInput("vowels",
                                   label = h4("Vowel"),
                                   choices = vowels,
                                   selected = c("FLEECE", "KIT", "FACE", "DRESS", "TRAP", "LOT", "THOUGHT", "STRUT", "GOAT", "FOOT", "GOOSE"),
                                   multiple = TRUE,
                                   selectize = FALSE,
                                   size = 14
                       )
                ),
                column(3,
                       selectInput("environments",
                                   label = h4("Environments"),
                                   choices = c("prelateral", "prerhotic", "prevelar", "prenasal", "prevelarnasal", "prevoiceless", "post-Y", "postcoronal", "elsewhere"),
                                   selected = c("elsewhere"),
                                   multiple = TRUE,
                                   selectize = FALSE,
                                   size = 14))
                
                # column(3,
                #        selectInput(paste0("stress_", side),
                #                    label= h4("Stress"),
                #                    choices = c("Primary", "Secondary", "No Stress"),
                #                    selected = "Primary",
                #                    multiple=T,
                #                    selectize = F,
                #                    size=3,
                #                    width="100%"
                #        ),
                #        selectInput(paste0("norm_", side),
                #                    label= h4("Normalization"),
                #                    choices = c("None", "Lobanov", "Bark Difference Metric"),
                #                    width="100%"
                #        ),
                #        selectInput(paste0("trans_", side),
                #                    label = h4("Transcription System"),
                #                    choices = c("ARPABET", "SAMPA", "Plotnik", "Wells' Lexical Sets"), # IPA
                #                    selected = "Wells' Lexical Sets",
                #                    width="100%"
                #                    
                #        )
                # )
              )
            ),
            
            # tabPanel("Words",
            #          fluidRow(
            #            column(3,
            #                   # radioButtons("include_exclude",
            #                   #              label = h3(""),
            #                   #              choices = c("Exclude these words"   = "hide",
            #                   #                          "Only show these words" = "show"),
            #                   #              width = "100%"),
            #                   # actionButton("stopwords_btn",
            #                   #              label = "Default stop words",
            #                   #              width = "100%"),
            #                   # actionButton("clear_words_btn",
            #                   #              label="Clear list",
            #                   #              width = "100%")
            #            ),
            #            column(9,
            #                   fluidRow(
            #                     column(12,
            #                            selectInput("wordlist",
            #                                        label = h3(""),
            #                                        choices  = allwords,
            #                                        selected = stopwords,
            #                                        multiple  = TRUE,
            #                                        selectize = TRUE,
            #                                        width = "100%"
            #                            )
            #                     )
            #                   )
            #            )
            #          )
            # ),
            
            
            tabPanel(
              title = "Plot",
              
              fluidRow(
                column(12,
                       column(2,
                              checkboxInput(inputId = "show_points",
                                            label   = h3("Points"),
                                            value   = 1),
                              sliderInput(inputId = "points_alpha",
                                          label = "Opacity",
                                          min = 0,
                                          max = 1,
                                          value = 1,
                                          width="100%"),
                              sliderInput(inputId = "points_size",
                                          label = "Size",
                                          min = 0.01,
                                          max = 10,
                                          value = 0.25,
                                          round = 1,
                                          width="100%")
                       ),
                       column(2,
                              checkboxInput(inputId = "show_ellipses",
                                            label   = h3("Ellipses"),
                                            value   = T),
                              sliderInput(inputId = "ellipses_alpha",
                                          label = "Opacity",
                                          min = 0,
                                          max = 1,
                                          value = 1,
                                          width="100%"),
                              sliderInput(inputId = "ellipses_size",
                                          label = "Size",
                                          min = 1,
                                          max = 100,
                                          value = 67,
                                          post = "%",
                                          width="100%")
                       ),
                       column(2,
                              checkboxInput(inputId = "show_means",
                                            label   = h3("Means"),
                                            value   = TRUE),
                              sliderInput(inputId = "means_alpha",
                                          label = "Opacity",
                                          min = 0,
                                          max = 1,
                                          value = 1,
                                          width="100%"),
                              sliderInput(inputId = "means_size",
                                          label = "Size",
                                          min = 2,
                                          max = 20,
                                          value = 10,
                                          width="100%")
                       ),
                       column(2,
                              checkboxInput(inputId = "show_words",
                                            label   = h3("Words"),
                                            value   = FALSE),
                              sliderInput(inputId = "words_alpha",
                                          label = "Opacity",
                                          min = 0,
                                          max = 1,
                                          value = 1,
                                          width="100%"),
                              sliderInput(inputId = "words_size",
                                          label = "Size",
                                          min = 0.01,
                                          max = 10,
                                          value = 3,
                                          width="100%")
                       ),
                       column(2,
                              selectInput("color_variable",
                                          label = h4("One color per..."),
                                          choices = c("phoneme", "allophone"),
                                          selected = c("phoneme"),
                                          multiple = FALSE,
                                          selectize = TRUE,
                              ),
                              selectInput("ellipse_variable",
                                          label = h4("One ellipse per..."),
                                          choices = c("phoneme", "allophone"),
                                          selected = c("allophone"),
                                          multiple = FALSE,
                                          selectize = TRUE,
                              ),
                              selectInput("label_variable",
                                          label = h4("One label per..."),
                                          choices = c("phoneme", "allophone"),
                                          selected = c("allophone"),
                                          multiple = FALSE,
                                          selectize = TRUE,
                              )
                       ),
                )
              ),
            ),
            
            
            tabPanel(
              title = "Customization",
              
              column(3,
                     textInput("title", 
                               label = "Title", 
                               value = NA),
                     textInput("subtitle",
                               label = "Subtitle",
                               value = NA),
                     textInput("x_label",
                               label = "x-axis label",
                               value = "F2"),
                     textInput("y_label",
                               label = "y-axis label",
                               value = "F1")
                     ),
              
              column(3,
                     sliderInput("base_size",
                                 label = "Overall font size",
                                 step = 1,
                                 min = 0,
                                 max = 48,
                                 value = 16,
                                 round = TRUE),
                     selectInput("base_family",
                                 label = h4("Font family"),
                                 choices = c("Avenir", "Courier", "Helvetica", "Palatino", "Times"),
                                 selected = c("Avenir"),
                                 multiple = FALSE,
                                 selectize = TRUE,
                     )
              ),
              column(3,
                     checkboxInput("show_legend", label = "Show legend?", value = FALSE),
                     )
            ),
            
            tabPanel(
              title = "Download"
            )
          ),
          plotOutput("midpoints_plot", width = "800px", height = "600px")
        ),
        
        # tabPanel(
        #   title = "Allophones",
        #   sidebarLayout(
        #     sidebarPanel(
        #       
        #     ),
        #     mainPanel(
        #     )
        #   )
        # ),
        # tabPanel(
        #   title = "Trajectories",
        #   sidebarLayout(
        #     sidebarPanel(
        #       
        #     ),
        #     mainPanel(
        #       
        #     )
        #   )
        # ),
        # tabPanel(
        #   title = "Other",
        #   sidebarLayout(
        #     sidebarPanel(
        #       
        #     ),
        #     mainPanel(
        #       
        #     )
        #   )
        # ),
        # )
      )
    )
  )
)

# Define server logic required to draw a histogram
server <- function(input, output) {
  
  # Use the sample data. If the upload button is clicked, overwrite that.
  # path_to_data <- "joey_darla.csv"
  # observeEvent(input$process_uploaded_button, {
  #   path_to_data <- input$uploaded_data$datapath
  # })
  # observeEvent(input$load_sample_button,      {
  #   path_to_data <- "joey_darla.csv"
  # })
  # full_df <- reactive(path_to_data, {
  #   process_data(path_to_data)
  # })
  
  # full_df <- eventReactive(input$load_sample_button, {
  #   read_csv(path_to_data, show_col_types = FALSE) %>%
  #     process_data()
  # })

  full_df <- eventReactive(input$process_uploaded_button, {
    req(input$uploaded_data)
    read_csv(input$uploaded_data$datapath, show_col_types = FALSE) %>%
      process_data()
  })
  
  # allwords <- reactive({
  #   sort(unique(full_df$word))
  # })
  
  output$midpoints_plot <- renderPlot({
    midpoint_df <- full_df() %>%
      filter(percent == 50,
             phoneme %in% input$vowels,
             allophone_environment %in% input$environments)

    # Basic elements
    p <- ggplot(midpoint_df, aes(F2, F1))

    # Optional elements
    if (input$show_points) {
      p <- p + geom_point(aes_string(color = input$color_variable),
                          size = input$points_size, alpha = input$points_alpha)
    }
    if (input$show_ellipses) {
      p <- p + stat_ellipse(aes_string(group = input$ellipse_variable, color = input$color_variable),
                            level = input$ellipses_size/100, alpha = input$ellipses_alpha)
    }
    if (input$show_means) {
      midpoint_labels <- midpoint_df %>%
        group_by(phoneme, allophone) %>%
        summarize(across(matches("F\\d"), mean), .groups = "drop_last")
      p <- p +
        geom_text(data = midpoint_labels, 
                  aes_string(color = input$color_variable, label = input$label_variable), 
                  size = input$means_size, alpha = input$means_alpha)
    }
    if (input$show_words) {
      p <- p + geom_text(aes_string(label = "word",
                                    color = input$color_variable), 
                         size = input$words_size, alpha = input$words_alpha)
    }

    # Final elements
    p <- p +
      scale_x_reverse() +
      scale_y_reverse() +
      labs(title = input$title,
           subtitle = input$subtitle,
           x = input$x_label,
           y = input$y_label) + 
      theme_minimal(base_size = input$base_size, base_family = input$base_family) + 
      theme(legend.position = if_else(input$show_legend, "right", "none"))

    p
    
  })
}

# Run the application 
shinyApp(ui = ui, server = server)
